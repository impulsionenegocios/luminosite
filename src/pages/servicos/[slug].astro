---
import { Image } from 'astro:assets';
import MainLayout from '../../layouts/mainLayout.astro';
import Button from '../../components/buttons/mainButton.astro';
import DotsShape from '../../components/shapes/dotsShape.astro';
import Heading from '../../components/typograph/Heading.astro';
import Paragraph from '../../components/typograph/Paragraph.astro';
import { getServiceBySlug, getServicePaths } from '../../data/servicesData';
import { getMainData } from '../../data/mainData';
import MdiIcon from '../../components/utils/MdiIcon.astro';

export async function getStaticPaths() {
  try {
    const paths = await getServicePaths();
    return paths;
  } catch {
    return [];
  }
}
// @ts-ignore
const { slug } = Astro.params;

let serviceData = null;
try {
  serviceData = await getServiceBySlug(slug);
} catch {
  return Astro.redirect('/404');
}

if (!serviceData) return Astro.redirect('/404');

let mainData = null;
try {
  mainData = await getMainData();
} catch {
  // @ts-ignore

  throw new Error('Erro ao buscar dados da cl√≠nica');
}
// @ts-ignore

const serviceName = serviceData.service_name;
const message = `Ol√°, tudo bem? Vim do site e queria saber mais sobre ${serviceData.service_name}`;
// @ts-ignore

const encodedMessage = encodeURIComponent(message);

const whatsappLink = `https://wa.me/${mainData?.whatsapp}?text=${encodedMessage}`;
// @ts-ignore

const contactLink = serviceData.YayFormsId ? '#contact' : whatsappLink;
// @ts-ignore

const metaTitle = `${serviceData.heroTitle} | ${mainData?.nome}`;
// @ts-ignore

const metaDescription = serviceData.heroDescription;

// Construir URL can√¥nica do servi√ßo
const currentUrl = `${Astro.site || 'https://luminoclinica.com.br'}/servicos/${slug}`;

// Schema Structured Data completo
const structuredData = {
  "@context": "https://schema.org",
  "@graph": [
    // 1. Service Schema - Servi√ßo principal
    {
      "@type": "MedicalProcedure",
      "@id": `${currentUrl}#service`,
      "name": serviceData.service_name,
      "alternateName": serviceData.heroTitle,
      "description": serviceData.heroDescription,
      "url": currentUrl,
      "image": serviceData.heroImage ? {
        "@type": "ImageObject",
        "url": serviceData.heroImage,
        "width": 1920,
        "height": 1080
      } : undefined,
      "provider": {
        "@id": `${Astro.site || 'https://luminoclinica.com.br'}#organization`
      },
      "procedureType": "Dental/Aesthetic Procedure",
      ...(serviceData.benefits && serviceData.benefits.length > 0 && {
        "benefits": serviceData.benefits.map(b => b.title).join(', ')
      }),
      ...(serviceData.casesBeforeAfter && serviceData.casesBeforeAfter.length > 0 && {
        "expectedPrognosis": "Resultados vis√≠veis comprovados em casos reais",
        "associatedAnatomy": {
          "@type": "AnatomicalStructure",
          "name": "Estrutura Dental e Facial"
        }
      }),
      "offers": {
        "@type": "Offer",
        "availability": "https://schema.org/InStock",
        "url": currentUrl,
        "priceCurrency": "BRL",
        "availableAtOrFrom": {
          "@id": `${Astro.site || 'https://luminoclinica.com.br'}#organization`
        }
      }
    },

    // 2. Medical Business Schema - Cl√≠nica/Dentista
    {
      "@type": ["Dentist", "MedicalBusiness", "LocalBusiness"],
      "@id": `${Astro.site || 'https://luminoclinica.com.br'}#organization`,
      "name": mainData?.nome || "Lumino Cl√≠nica",
      "description": `Cl√≠nica odontol√≥gica e est√©tica especializada em ${serviceData.service_name}`,
      "url": Astro.site || 'https://luminoclinica.com.br',
      "logo": {
        "@type": "ImageObject",
        "url": `${Astro.site || 'https://luminoclinica.com.br'}/logo.png`
      },
      "image": serviceData.authFeaturedImage || serviceData.heroImage,
      "telephone": mainData?.telefone,
      "email": mainData?.email,
      "address": {
        "@type": "PostalAddress",
        "addressLocality": mainData?.endereco,
        "addressCountry": "BR"
      },
      "medicalSpecialty": ["Dentistry", "CosmeticDentistry", "AestheticMedicine"],
      "priceRange": "$$",
      ...(mainData?.numero_cro && {
        "identifier": {
          "@type": "PropertyValue",
          "propertyID": "CRO",
          "value": mainData.numero_cro
        }
      }),
      ...(mainData?.responsavel_tecnico && {
        "employee": {
          "@type": "Person",
          "name": mainData.responsavel_tecnico,
          "jobTitle": "Respons√°vel T√©cnico"
        }
      }),
      "hasOfferCatalog": {
        "@type": "OfferCatalog",
        "name": "Servi√ßos Odontol√≥gicos e Est√©ticos",
        "itemListElement": [{
          "@type": "Offer",
          "itemOffered": {
            "@id": `${currentUrl}#service`
          }
        }]
      }
    },

    // 3. BreadcrumbList Schema - Navega√ß√£o
    {
      "@type": "BreadcrumbList",
      "@id": `${currentUrl}#breadcrumb`,
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "In√≠cio",
          "item": Astro.site || 'https://luminoclinica.com.br'
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Servi√ßos",
          "item": `${Astro.site || 'https://luminoclinica.com.br'}/servicos`
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": serviceData.service_name,
          "item": currentUrl
        }
      ]
    },

    // 4. FAQPage Schema - Perguntas Frequentes (SEMPRE presente)
    {
      "@type": "FAQPage",
      "@id": `${currentUrl}#faq`,
      "url": `${currentUrl}#faq`,
      "name": `Perguntas Frequentes sobre ${serviceData.service_name}`,
      "mainEntity": serviceData.faqItems && serviceData.faqItems.length > 0
        ? serviceData.faqItems.map(faq => ({
            "@type": "Question",
            "name": faq.question,
            "acceptedAnswer": {
              "@type": "Answer",
              "text": faq.answer
            }
          }))
        : [{
            "@type": "Question",
            "name": `Informa√ß√µes sobre ${serviceData.service_name}`,
            "acceptedAnswer": {
              "@type": "Answer",
              "text": serviceData.heroDescription
            }
          }]
    },

    // 5. ImageGallery Schema - Casos Antes/Depois (SEMPRE presente)
    {
      "@type": "ImageGallery",
      "@id": `${currentUrl}#casos`,
      "url": `${currentUrl}#casos`,
      "name": `Casos de ${serviceData.service_name} - Antes e Depois`,
      "description": serviceData.casesDescription || `Galeria de resultados reais de ${serviceData.service_name}`,
      ...(serviceData.casesBeforeAfter && serviceData.casesBeforeAfter.length > 0 && {
        "image": serviceData.casesBeforeAfter.flatMap(c => [
          {
            "@type": "ImageObject",
            "url": c.before,
            "name": `Antes - ${c.title}`,
            "description": c.description,
            "representativeOfPage": false
          },
          {
            "@type": "ImageObject",
            "url": c.after,
            "name": `Depois - ${c.title}`,
            "description": c.description,
            "representativeOfPage": false
          }
        ]).filter(img => img.url)
      })
    },

    // 6. WebPage Schema - P√°gina em si
    {
      "@type": "WebPage",
      "@id": currentUrl,
      "url": currentUrl,
      "name": metaTitle,
      "description": metaDescription,
      "isPartOf": {
        "@type": "WebSite",
        "@id": `${Astro.site || 'https://luminoclinica.com.br'}#website`,
        "name": mainData?.nome || "Lumino Cl√≠nica",
        "url": Astro.site || 'https://luminoclinica.com.br'
      },
      "about": {
        "@id": `${currentUrl}#service`
      },
      "breadcrumb": {
        "@id": `${currentUrl}#breadcrumb`
      },
      "specialty": "Odontologia e Est√©tica",
      "primaryImageOfPage": {
        "@type": "ImageObject",
        "url": serviceData.heroImage
      },
      "hasPart": [
        {
          "@id": `${currentUrl}#faq`
        },
        {
          "@id": `${currentUrl}#casos`
        },
        ...(serviceData.benefits && serviceData.benefits.length > 0 ? [{
          "@id": `${currentUrl}#benefits`
        }] : [])
      ]
    },

    // 7. ItemList Schema - Lista de Benef√≠cios (se existirem)
    ...(serviceData.benefits && serviceData.benefits.length > 0 ? [{
      "@type": "ItemList",
      "@id": `${currentUrl}#benefits`,
      "name": `Benef√≠cios de ${serviceData.service_name}`,
      "description": serviceData.benefitsDescription,
      "numberOfItems": serviceData.benefits.length,
      "itemListElement": serviceData.benefits.map((benefit, index) => ({
        "@type": "ListItem",
        "position": index + 1,
        "name": benefit.title,
        "description": benefit.text
      }))
    }] : [])
  ]
};

// Remover propriedades undefined e converter para string JSON
const cleanedStructuredData = JSON.parse(JSON.stringify(structuredData));
const structuredDataString = JSON.stringify(cleanedStructuredData);
---

<MainLayout
  title={metaTitle}
  description={metaDescription}
  structured_data={structuredDataString}
  canonical={currentUrl}
  og_title={metaTitle}
  og_description={metaDescription}
  og_image={serviceData.heroImage}
>
  <!-- Hero Section -->
  <section class="h-[100vh] bg-white flex items-center overflow-hidden relative" id="hero-bg">
    <div class="hero-bg">
      {
        serviceData.heroImage && (
          <Image
            src={serviceData.heroImage}
            alt={serviceData.heroTitle}
            class="hero-bg-image"
            loading="eager"
            width="1920"
            height="1080"
            decoding="async"
            format="webp"
            quality="90"
          />
        )
      }
    </div>
    <div class="counter-particles"></div>
    <div class="mx-auto max-w-[1600px] lg:pl-40 w-full z-10">
      <div class="lg:w-[50%] px-8 lg:px-0 z-3">
        <span class="text-primary-gold font-bold animate-subtitle">
          {serviceData.heroSubtitle}
        </span>
        <br />

        <Heading text={serviceData.heroTitle} accent={serviceData.heroTitleAccent} />
        <p class="text-xs text-gray-600 animate-description mt-6 leading-relaxed">
          {serviceData.heroDescription}
        </p>
        <div class="flex flex-col lg:flex-row gap-4 animate-buttons mt-8">
          <Button title="Quero agendar minha avalia√ß√£o" href={contactLink} />
          <Button title="Saber Mais" href="#for-who" variant="outline" />
        </div>
      </div>
      <DotsShape />
      <div class="scroll-down !bottom-[20px]">
        <span>&nbsp;</span>
        <p>Deslize para baixo</p>
      </div>
    </div>
  </section>

  <!-- Para quem √© -->
  {
    serviceData.forWho && serviceData.forWho.length > 0 && (
      <section class="px-8 lg:px-16 py-8 lg:py-16 bg-white" id="for-who">
        <div>
          <div class="text-center mb-16">
            <h2 class="section-title section-title-center">
              √â pra <span class="accent">voc√™ que...</span>
            </h2>
          </div>

          <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
            {serviceData.forWho.map((item) => (
              <div class="text-center reveal-effect">
                <div class="w-24 h-24 mx-auto mb-6 bg-light-bg rounded-2xl flex items-center justify-center hover:bg-primary-gold hover:text-white transition-all duration-500 transform hover:-translate-y-2">
                  <MdiIcon name={item.icon || ''} size={32} className="mx-auto" />
                </div>
                <p class="text-gray-700 font-medium">{item.text}</p>
              </div>
            ))}
          </div>
        </div>
      </section>
    )
  }

  <!-- Benef√≠cios -->
  {
    serviceData.benefits && serviceData.benefits.length > 0 && (
      <section class="bg-primary-dark text-white px-8 lg:px-16 py-8 lg:py-16" id="beneficios">
        <div class="shape shape-3" />
        <div>
          <div class="text-center mb-16">
            <Heading
              text={serviceData.benefitsTitle}
              accent={serviceData.benefitsTitleAccent}
              color="white"
            />
            {serviceData.benefitsDescription && (
              <p class="section-subtitle section-subtitle-center text-white/70">
                {serviceData.benefitsDescription}
              </p>
            )}
          </div>

          <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
            {serviceData.benefits.map((benefit) => (
              <div class="text-center reveal-effect group cursor-pointer">
                <div class="w-20 h-20 mx-auto mb-6 bg-white/10 rounded-2xl flex items-center justify-center text-3xl group-hover:bg-primary-gold transition-all duration-500 transform group-hover:scale-110">
                  <MdiIcon name={benefit.icon || ''} size={32} className="mx-auto" />
                </div>
                <h3 class="text-xl font-bold mb-2 text-primary-gold">{benefit.title}</h3>
                <p class="text-white/80">{benefit.text}</p>
              </div>
            ))}
          </div>
        </div>
      </section>
    )
  }

  <!-- Casos Reais (Galeria) - CORRIGIDO -->
  {
    serviceData.casesBeforeAfter && serviceData.casesBeforeAfter.length > 0 ? (
      <section class="bg-light-bg px-8 lg:px-16 py-8 lg:py-16" id="casos">
        <div class="shape shape-2" />
        <div>
          <div class="gallery-header text-center mb-12">
            <Heading text={serviceData.casesTitle} accent={serviceData.casesTitleAccent} />
            {serviceData.casesDescription && (
              <p class="section-subtitle section-subtitle-center">{serviceData.casesDescription}</p>
            )}
          </div>

          <div class="gallery-container reveal-effect">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8">
              {serviceData.casesBeforeAfter.map((caseItem, index) => (
                <div class="bg-white  rounded-2xl overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 group">
                  <div class="grid grid-cols-2 lg:min-h-[300px]">
                    {/* Imagem ANTES */}
                    <div class="relative overflow-hidden">
                      {caseItem.before ? (
                        <img
                          src={caseItem.before}
                          alt={`Antes do tratamento - ${caseItem.title}`}
                          class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                          loading="lazy"
                          decoding="async"
                        />
                      ) : (
                        <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                          <span class="text-gray-400">Sem imagem</span>
                        </div>
                      )}
                      <div class="absolute top-3 left-3 bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold shadow-lg">
                        ANTES
                      </div>
                    </div>

                    {/* Imagem DEPOIS */}
                    <div class="relative overflow-hidden">
                      {caseItem.after ? (
                        <img
                          src={caseItem.after}
                          alt={`Depois do tratamento - ${caseItem.title}`}
                          class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                          loading="lazy"
                          decoding="async"
                        />
                      ) : (
                        <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                          <span class="text-gray-400">Sem imagem</span>
                        </div>
                      )}
                      <div class="absolute top-3 right-3 bg-green-500 text-white px-2 py-1 rounded-full text-xs font-bold shadow-lg">
                        DEPOIS
                      </div>
                    </div>
                  </div>

                  {/* Informa√ß√µes do caso */}
                  <div class="p-6">
                    <h4 class="font-bold text-lg text-primary-dark mb-2">{caseItem.title}</h4>
                    <p class="text-gray-600 text-sm">{caseItem.description}</p>
                  </div>
                </div>
              ))}
            </div>

            <div class="text-center mt-12">
              <Button title={serviceData.CasesButtonTitle} href={contactLink} />
            </div>
          </div>
        </div>
      </section>
    ) : (
      <section class="bg-light-bg px-8 lg:px-16 py-8 lg:py-16" id="casos">
        <div class="text-center">
          <h2 class="text-2xl font-bold text-primary-dark mb-4">Casos de Sucesso em Breve</h2>
          <p class="text-gray-600 mb-8">
            Estamos preparando uma galeria incr√≠vel com nossos casos de sucesso.
          </p>
          <Button title="Entre em contato para ver casos" href={contactLink} />
        </div>
      </section>
    )
  }

  <!-- Autoridade e Confian√ßa -->
  {
    serviceData.authTitle && serviceData.authTitleAccent && (
      <section class="bg-white px-8 lg:px-16 py-8 lg:py-16" id="sobre-nos">
        <div>
          <div class="grid lg:grid-cols-2 gap-16 items-center">
            <div class="reveal-effect">
              <Heading text={serviceData.authTitle} accent={serviceData.authTitleAccent} />
              <Paragraph text={serviceData.authDescription} />

              {serviceData.authItems && serviceData.authItems.length > 0 && (
                <div class="grid grid-cols-3 gap-8 mt-8">
                  {serviceData.authItems.map((item) => (
                    <div class="text-center">
                      <div class="text-4xl font-bold text-primary-gold mb-2">{item.value}</div>
                      <p class="text-sm text-gray-600">{item.description}</p>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div class="relative reveal-effect">
              {serviceData.authFeaturedImage && (
                <Image
                  src={serviceData.authFeaturedImage}
                  alt="Equipe L√∫mino Cl√≠nica"
                  width="400"
                  height="400"
                  loading="lazy"
                  decoding="async"
                  format="webp"
                  quality="80"
                  class="rounded-2xl shadow-2xl w-full"
                />
              )}
              {serviceData.authBadgeTitleOne && serviceData.authBadgeTitleTwo && (
                <div class="absolute -bottom-6 -right-6 bg-primary-gold text-white px-8 py-4 rounded-2xl font-bold shadow-xl">
                  <div class="text-center">
                    <div class="text-2xl">{serviceData.authBadgeTitleOne}</div>
                    <div class="text-sm font-normal">{serviceData.authBadgeTitleTwo}</div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </section>
    )
  }

  <!-- FAQ -->
  {
    serviceData.faqItems && serviceData.faqItems.length > 0 && (
      <section class="bg-light-bg px-8 lg:px-16 py-8 lg:py-16" id="faq">
        <div class="shape shape-2" />
        <div>
          <div class="max-w-4xl mx-auto">
            <div class="text-center mb-16">
              <Heading text={serviceData.faqTitle} accent={serviceData.faqTitleAccent} />
            </div>

            <div class="space-y-4">
              {serviceData.faqItems.map((faq, index) => (
                <div class="bg-white rounded-2xl overflow-hidden reveal-effect">
                  <button
                    class="w-full text-left p-6 font-bold text-primary-dark hover:bg-light-bg transition-colors duration-300 flex items-center justify-between faq-toggle"
                    data-target={`faq-${index + 1}`}
                  >
                    <span class="flex items-center">
                      <span class="mr-4 text-2xl text-primary-gold">üëâ</span>
                      {faq.question}
                    </span>
                    <svg
                      class="w-5 h-5 transition-transform duration-300 faq-icon text-primary-gold"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19 9l-7 7-7-7"
                      />
                    </svg>
                  </button>
                  <div
                    id={`faq-${index + 1}`}
                    class="hidden p-6 pt-4 text-gray-700 leading-relaxed faq-content"
                  >
                    {faq.answer}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </section>
    )
  }

  <!-- CTA Final -->
  <section class="contact-cta !px-8 lg:!px-16 !py-8 lg:!py-16" id="cta">
    <div class="contact-cta-shape contact-cta-shape-1"></div>
    <div class="contact-cta-shape contact-cta-shape-2"></div>

    <div class="text-center">
      <Heading text={serviceData.ctaTitle} accent={serviceData.ctaTitleAccent} color="white" />
      <div class="mt-4">
        <Paragraph text={serviceData.ctaDescription} />
      </div>

      <div class="mt-8">
        <Button title="Quero agendar minha avalia√ß√£o" href={contactLink} />
        <Button title="Saber Mais" href="#for-who" variant="outline" />
      </div>
    </div>
  </section>
  <!-- Contact Form Section - Only shows if YayFormsId exists -->
  {
    serviceData.YayFormsId && (
      <section class="h-[80svh]" id="contact">
        <div
          id="yay-container"
          data-yf-widget={serviceData.YayFormsId}
          data-form-id={serviceData.YayFormsId}
          style="width:100%;height:100%;"
        />
      </section>
    )
  }
  <!-- Footer -->
  <section class="bg-primary-dark text-white px-8 lg:px-16 py-8 lg:py-16" id="tecnical">
    <div>
      <div class="text-center">
        <h3 class="font-cormorant text-3xl font-bold mb-6">
          {mainData?.nome || ''}
        </h3>
        <p class="text-sm text-white/60 mb-8">
          CRO: {mainData?.numero_cro} | Respons√°vel T√©cnico: {mainData?.responsavel_tecnico}
        </p>

        <div class="flex flex-wrap justify-center items-center gap-8 text-sm text-white/70">
          <div class="flex items-center gap-2">
            <span>üìç</span>
            <span>Atendemos na regi√£o de {mainData?.endereco}</span>
          </div>
          <div class="flex items-center gap-2">
            <span>üìû</span>
            <span>{mainData?.telefone}</span>
          </div>
          <div class="flex items-center gap-2">
            <span>üìß</span>
            <span>{mainData?.email}</span>
          </div>
        </div>

        <div class="mt-12 pt-8 border-t border-white/10">
          <p class="text-xs text-white/50 max-w-4xl mx-auto italic">
            *Este site tem car√°ter exclusivamente informativo e segue as diretrizes do C√≥digo de
            √âtica Odontol√≥gica. A avalia√ß√£o presencial √© essencial para diagn√≥stico individualizado.
          </p>
        </div>
      </div>
    </div>
  </section>
</MainLayout>

<script is:inline>
  document.addEventListener('DOMContentLoaded', function () {
    // Coleta os par√¢metros da URL
    const queryParams = new URLSearchParams(window.location.search);
    const paramString = queryParams.toString();

    // Pega o ID do formul√°rio do atributo
    const yayContainer = document.getElementById('yay-container');
    if (!yayContainer) return; // Se n√£o h√° container, n√£o h√° formul√°rio

    const formId = yayContainer.getAttribute('data-form-id');

    if (!formId) return; // Prote√ß√£o extra

    // Cria o iframe
    const iframe = document.createElement('iframe');
    iframe.src = `https://yayforms.link/${formId}` + (paramString ? `?${paramString}` : '');
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = 'none';
    yayContainer.appendChild(iframe);
  });
</script>

<script is:inline>
  document.addEventListener('DOMContentLoaded', function () {
    // FAQ toggle
    document.querySelectorAll('.faq-toggle').forEach((toggle) => {
      toggle.addEventListener('click', function () {
        const targetId = this.getAttribute('data-target');
        const faqContent = document.getElementById(targetId);
        const icon = this.querySelector('.faq-icon');
        if (!faqContent || !icon) return;

        document.querySelectorAll('.faq-content').forEach((content) => {
          if (content.id !== targetId) content.classList.add('hidden');
        });
        document.querySelectorAll('.faq-icon').forEach((faqIcon) => {
          if (faqIcon !== icon) faqIcon.style.transform = 'rotate(0deg)';
        });

        if (faqContent.classList.contains('hidden')) {
          faqContent.classList.remove('hidden');
          icon.style.transform = 'rotate(180deg)';
        } else {
          faqContent.classList.add('hidden');
          icon.style.transform = 'rotate(0deg)';
        }
      });
    });
  });
</script>

<style>
  #tecnical {
    zoom: 0.9;
  }
  #cta {
    zoom: 0.9;
  }
  #faq {
    zoom: 0.9;
  }
  #sobre-nos {
    zoom: 0.9;
  }
  #casos {
    zoom: 0.9;
  }
  #for-who {
    zoom: 0.9;
  }
  #beneficios {
    zoom: 0.9;
  }
</style>
